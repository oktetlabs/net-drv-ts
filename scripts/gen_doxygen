#!/bin/bash
# SPDX-License-Identifier: Apache-2.0
# (c) Copyright 2021 - 2022 Xilinx, Inc. All rights reserved.
set -e

export TS_TOPDIR="$(cd "$(dirname "$(which "$0")")/.."; pwd -P)"
. ${TS_TOPDIR}/scripts/guess.sh

doxygen_debug=false

do_default=true
do_pdf=false
do_html=false
doc_language=""
rst_override_dir=""
use_xml2dox=true
manual_override_dir=""
DOC_SRC_DIR="net-drv-ts/doc"
TMP_DOC_SRC_DIR=""
DOXYFILE_TMP=""

help() {
    cat <<EOF
Tool is used to generate documentation for the net-drv-ts test suite.

It's based on doxygen and doxyrest.

Usage: ./$0 [--help] [--debug] [--html] [--pdf] [--rst-override-generated=DIR] [--rst-override-manual=DIR] [--no-xml2dox] [--lang=LANG]

Options:
    --html: generate html documentation (default)
    --pdf: generate pdf documentation
    --debug: enable debug mode
    --rst-override-generated=DIR: copy contents of DIR into 
                                  net-drv-ts/doc/generated/rst after doxyrest
    --rst-override-manual=DIR: override manual sources (index.rst; manual/*.rst -> net-drv-ts/doc/dox_resources)
    --no-xml2dox: disable xml2dox filters in Doxygen (keep c2dox)
    --lang=LANG: set Sphinx document language (e.g. en, ru)
    --help: show this help message
EOF
}

for opt ; do
    case "${opt}" in
        --help|-h)
            help
            exit 0
            ;;
        -d|--debug)
            doxygen_debug=true
            ;;
        --html)
            do_default=false
            do_html=true
            ;;
        --pdf)
            do_default=false
            do_pdf=true
            ;;
        --rst_override_generated=*|--rst-override-generated=*)
            rst_override_dir="${opt#*=}"
            ;;
        --rst_override_manual=*|--rst-override-manual=*)
            manual_override_dir="${opt#*=}"
            ;;
        --no-xml2dox)
            use_xml2dox=false
            ;;
        --lang=*|--language=*)
            doc_language="${opt#*=}"
            ;;
        *)
            echo "Unknown option: $opt" >&2
            help
            exit 1
            ;;
    esac
done

if [ -z "$DOXYREST_PREFIX" ]; then
    $TE_BASE/scripts/doxyrest_deploy.sh --how
    exit -1
fi
[ -z "$DOXYREST_BIN" ] && DOXYREST_BIN="$DOXYREST_PREFIX/bin/doxyrest"

[ -z "$SPHINX_BUILD_BIN" ] && SPHINX_BUILD_BIN="sphinx-build"
if ! which $SPHINX_BUILD_BIN >/dev/null; then
    echo "Please install sphinx before:"
    echo " $ pip install sphinx sphinx_rtd_theme"
    exit -2
fi

pushd ${TS_TOPDIR} >/dev/null

# Choose Doxyfile, optionally overriding FILTER_PATTERNS to disable xml2dox
DOXYFILE="net-drv-ts/Doxyfile"
if ! $use_xml2dox; then
    DOXYFILE_TMP="$(mktemp -t Doxyfile.XXXXXXXX)" || {
        echo "Failed to create temporary Doxyfile" >&2
        exit 6
    }
    cp "$DOXYFILE" "$DOXYFILE_TMP"
    cat >>"$DOXYFILE_TMP" <<'EOF'

# Overridden by gen_doxygen: disable xml2dox, keep c2dox
FILTER_PATTERNS        = *.c="${TE_BASE}/scripts/c2dox"
EOF
    DOXYFILE="$DOXYFILE_TMP"
fi

if $doxygen_debug ; then
   doxygen -d extcmd -d filteroutput "$DOXYFILE"
else
  doxygen "$DOXYFILE" >/dev/null
fi

DOXYREST_OPTS=(
    --config=net-drv-ts/doc/doxyrest-config.lua
    --frame-dir=$DOXYREST_PREFIX/share/doxyrest/frame/cfamily
    --frame-dir=$DOXYREST_PREFIX/share/doxyrest/frame/common
)

${DOXYREST_BIN} "${DOXYREST_OPTS[@]}" || exit 1

# If rst_override is specified, copy its contents into generated RST
if [ -n "$rst_override_dir" ]; then
    if [ ! -d "$rst_override_dir" ]; then
        echo "rst_override directory does not exist: $rst_override_dir" >&2
        exit 3
    fi
    mkdir -p net-drv-ts/doc/generated/rst
    cp -a "$rst_override_dir"/. net-drv-ts/doc/generated/rst/
fi

# If manual overrides are specified, prepare a temporary doc source tree
if [ -n "$manual_override_dir" ]; then
    if [ ! -d "$manual_override_dir" ]; then
        echo "rst_override_manual directory does not exist: $manual_override_dir" >&2
        exit 4
    fi
    TMP_DOC_SRC_DIR="$(mktemp -d -t docsrc.XXXXXXXX)" || {
        echo "Failed to create temporary doc source directory" >&2
        exit 5
    }
    # Copy the whole docs tree into temp to avoid touching git-tracked files
    cp -a net-drv-ts/doc/. "${TMP_DOC_SRC_DIR}/"
    # Override index.rst if provided
    if [ -f "${manual_override_dir}/index.rst" ]; then
        cp -a "${manual_override_dir}/index.rst" "${TMP_DOC_SRC_DIR}/index.rst"
    fi
    # Override dox_resources/*.rst from manual/*.rst
    if [ -d "${manual_override_dir}/resources" ]; then
        mkdir -p "${TMP_DOC_SRC_DIR}/dox_resources"
        for f in "${manual_override_dir}"/resources/*.rst; do
            [ -e "$f" ] || continue
            cp -a "$f" "${TMP_DOC_SRC_DIR}/dox_resources/$(basename "$f")"
        done
    fi
    DOC_SRC_DIR="${TMP_DOC_SRC_DIR}"
else
    DOC_SRC_DIR="$PWD/net-drv-ts/doc"
fi

if $do_default; then
    do_html=true
    do_pdf=false
fi

if $do_html; then
    SPHINX_BUILD_OPTS=(
        -j auto                         # use cpu count
        -q                              # be quite: warn and error only
    )
    if [ -n "$doc_language" ]; then
        SPHINX_BUILD_OPTS+=( -D "language=$doc_language" )
    fi
    SPHINX_BUILD_OPTS+=(
        "$DOC_SRC_DIR"              # input
        net-drv-ts/doc/generated/html       # output
    )

    ${SPHINX_BUILD_BIN} "${SPHINX_BUILD_OPTS[@]}"
fi

if $do_pdf; then
    ${TE_BASE}/scripts/rst_adjust \
        --toctree-move-to-end \
        --refs-remove \
        --authors-strip \
        net-drv-ts/doc/generated/rst/group_*.rst

    if [ -n "$doc_language" ]; then PDF_SPHINXOPTS="-D language=$doc_language"; else PDF_SPHINXOPTS=""; fi
    # Build PDF using Sphinx Makefile while pointing SOURCEDIR to our (possibly temporary) source tree
    make -C "${TS_TOPDIR}/net-drv-ts/doc" latexpdf SPHINXOPTS="$PDF_SPHINXOPTS" SOURCEDIR="$DOC_SRC_DIR"

    # Note, the name depends on conf.py!
    echo Open: $(realpath net-drv-ts/doc/generated/latex/net_driver_test_suite.pdf)
fi

# Cleanup temporary source dir if used
if [ -n "$TMP_DOC_SRC_DIR" ] && [ -d "$TMP_DOC_SRC_DIR" ]; then
    rm -rf "$TMP_DOC_SRC_DIR"
fi

# Cleanup temporary Doxyfile if used
if [ -n "$DOXYFILE_TMP" ] && [ -f "$DOXYFILE_TMP" ]; then
    rm -f "$DOXYFILE_TMP"
fi

popd >/dev/null
